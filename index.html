<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invidious Video Viewer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Invidious Video Viewer</h1>
            <div id="instanceInfo" class="text-sm text-gray-600"></div>
        </div>
        
        <!-- 検索フォーム -->
        <div class="mb-8">
            <form id="searchForm" class="flex gap-4">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="flex-1 p-2 border rounded" 
                    placeholder="検索キーワードを入力..."
                    required
                >
                <button 
                    type="submit" 
                    id="searchButton"
                    class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600"
                >
                    検索
                </button>
            </form>
        </div>

        <!-- ローディングインジケータ -->
        <div id="loading" class="hidden text-center py-4">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>

        <!-- エラーメッセージ -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"></div>

        <!-- 検索結果表示エリア -->
        <div id="searchResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- 動画プレイヤーモーダル -->
        <div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg w-full max-w-4xl">
                <div id="videoPlayer" class="aspect-w-16 aspect-h-9 mb-4"></div>
                <button 
                    id="closeModal" 
                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                >
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <script>
        // UI要素の取得
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const loadingIndicator = document.getElementById('loading');
        const errorMessageDiv = document.getElementById('errorMessage');
        const searchResults = document.getElementById('searchResults');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const closeModal = document.getElementById('closeModal');
        const instanceInfo = document.getElementById('instanceInfo');

        // インスタンス情報の更新
        async function updateInstanceInfo() {
            try {
                const response = await fetch('/api/instances');
                const data = await response.json();
                instanceInfo.textContent = `接続中のサーバー: ${new URL(data.current).hostname} (利用可能: ${data.total}台)`;
            } catch (error) {
                instanceInfo.textContent = 'サーバー情報を取得できません';
            }
        }

        // 定期的にインスタンス情報を更新
        updateInstanceInfo();
        setInterval(updateInstanceInfo, 30000);

        // ローディング表示の制御
        function setLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
            searchButton.disabled = isLoading;
            searchButton.textContent = isLoading ? '検索中...' : '検索';
        }

        // エラーメッセージの表示
        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            setTimeout(() => {
                errorMessageDiv.classList.add('hidden');
            }, 5000);
        }

        // 検索処理
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            
            if (!query) {
                showError('検索キーワードを入力してください');
                return;
            }

            setLoading(true);
            errorMessageDiv.classList.add('hidden');
            searchResults.innerHTML = '';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('検索リクエストに失敗しました');
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                displayResults(data);
            } catch (error) {
                console.error('検索エラー:', error);
                showError(`検索中にエラーが発生しました: ${error.message}`);
                searchResults.innerHTML = '';
            } finally {
                setLoading(false);
            }
        });

        // 検索結果の表示
        function displayResults(results) {
            if (!Array.isArray(results) || results.length === 0) {
                searchResults.innerHTML = '<p class="col-span-full text-center text-gray-600">検索結果が見つかりませんでした</p>';
                return;
            }

            results.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'bg-white rounded-lg shadow overflow-hidden hover:shadow-lg transition-shadow duration-300';
                
                const duration = formatDuration(video.duration);
                const viewCount = formatViewCount(video.viewCount);

                videoCard.innerHTML = `
                    <div class="relative">
                        <img 
                            src="${video.thumbnailUrl}" 
                            alt="${video.title}" 
                            class="w-full h-48 object-cover"
                            onerror="this.src='https://via.placeholder.com/480x360.png?text=No+Thumbnail'"
                        >
                        <span class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm">
                            ${duration}
                        </span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-2 line-clamp-2">${video.title}</h3>
                        <p class="text-gray-600 text-sm mb-2">${video.author}</p>
                        <p class="text-gray-500 text-sm">${viewCount} 回視聴</p>
                        <button 
                            class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-300 w-full"
                            onclick="playVideo('${video.videoId}')"
                        >
                            再生
                        </button>
                    </div>
                `;
                searchResults.appendChild(videoCard);
            });
        }

        // 動画再生
        async function playVideo(videoId) {
            try {
                setLoading(true);
                const response = await fetch(`/api/videos/${videoId}`);
                if (!response.ok) throw new Error('動画の取得に失敗しました');
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                videoPlayer.innerHTML = `
                    <iframe
                        src="${data.embedUrl}"
                        class="w-full h-full"
                        style="aspect-ratio: 16/9;"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
